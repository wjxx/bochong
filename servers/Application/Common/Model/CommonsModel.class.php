<?php
/**
 * 公共模型工具库
 * ============================================================================
 * 版权所有 (C) 
 * 网站地址:
 * ============================================================================
 * $Version: v1.0.0 Beta $
 * $Author: LWX <liwenxuan@pokpets.com> $
 * $Date: 2016/7/6 14:50 $
 * $Id: CommonsModel.class.php 14:50 2016/7/6 $
**/
namespace Common\Model;
use Think\Model;
class CommonsModel {
	
	private $KeyArray = array();
	
	/**
	 *+--------------------------------------------------------------------------------------------------------------------
	 * 数组KEY关键值提取
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @Author LWX  Date:2016/7/6
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @access public
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @type POST
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $key 目标数组key				
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $val 目标数组值
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @return Array
	 *+--------------------------------------------------------------------------------------------------------------------
	**/
	public function KeyArray($key, $val) {
		foreach($val as $k=>$v) {
			if(is_array($v)) {
				$val[$k] = $this->KeyArray($key, $v);
			} else if(in_array($k, $key)) {
				$v = explode(',', $v);
				foreach($v as $vs) {
					$vs = trim($vs);
					if(!empty($vs)) {
						$this->KeyArray[$vs] = '';
					}
				}
			}
		}

		return $this->KeyArray;
	}

	/**
	 *+--------------------------------------------------------------------------------------------------------------------
	 * 文件KEY数组值替换
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @Author LWX  Date:2016/7/6
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @access public
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @type POST
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $key 目标数组key				
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $val 目标数组值
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @return Array
	 *+--------------------------------------------------------------------------------------------------------------------
	**/
	public function FilesKeyValArray($key, $val, $state=false) {
		foreach($val as $k=>$v) {
			if(is_array($v)) {
				$val[$k] = $this->FilesKeyValArray($key, $v, $state);
			} else {
				$v = trim($v);
				$v = explode(',', $v);
				if(count($v) > 1) {
					$array = array();
					foreach($v as $vst) {
						if(strlen($vst) == 64 && !empty($key[$vst])) {
							if($state) {
								$array[] = array(
									'key'=>$vst,
									'url'=>$key[$vst]
								);
							} else {
								$array[] = $key[$vst];
							}
						} else {
							$array[] = $vst;
						}
					}
					$val[$k] = $array;
				} else if(strlen($v[0]) == 64 && !empty($key[$v[0]])){
					if($state) {
						$val[$k] = array(
							array(
								'key'=>$v[0],
								'url'=>$key[$v[0]]
							)
						);
					} else {
						$val[$k] = array($key[$v[0]]);
					}
				}
			}
		}
		
		return $val;
	}
	
	/**
	 *+--------------------------------------------------------------------------------------------------------------------
	 * 获取转换文件数组URL
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @Author LWX  Date:2016/7/6
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @access public
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @type POST
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $key 目标数组key				
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $val 目标数组值
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @return Array
	 *+--------------------------------------------------------------------------------------------------------------------
	**/
	public function FilesGetUrl($key, $val, $state=false) {
		$this->KeyArray = array();
		$key_json = $this->KeyArray($key, $val);
				
		$data = array();
		$data = array('key_json'=>$key_json );
		$data = curls(C('APIURL').'Files/GetUrl', 'post', $data, true);
		$data = $data['data'];

		return $this->FilesKeyValArray($data, $val, $state);
	}
	
	/**
	 *+--------------------------------------------------------------------------------------------------------------------
	 * 对数组的数字KEY从新生成，主要避免JSON从新排序问题
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @Author LWX  Date:2016/8/9
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @access public
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @type POST
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @parame Array 必填 $val 		
	 *+--------------------------------------------------------------------------------------------------------------------
	 * @return Array
	 *+--------------------------------------------------------------------------------------------------------------------
	**/
	public function ArrayJsonNumber($val) {
		$one = 0;
		foreach($val as $k=>$v) {
			
			if($k == '0' || intval($k)) {
				unset($val[$k]);
				$k = $one;
				$val[$k] = $v;
			}
			$one++;
			
			if(is_array($v)) {
				$val[$k] = $this->ArrayJsonNumber($v);
			} else {
				$val[$k] = $v;
			}
		}
		return $val;
	}






}
